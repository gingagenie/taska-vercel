# Taska Quotes/Invoices — Xero‑Style Reskin (Drop‑in for Existing App)

This is a **drop‑in UI layer** that keeps your existing logic (customers, presets, tax, Xero sync) and only rewires the front‑end components to feel like Xero. It’s frameworked for React + Tailwind. If you’re using TypeScript, rename files to `.tsx` and add types (inline comments show where).

> **What changes?** Only the presentation + item/preset UX. Your stores, API calls, and Xero code stay as‑is.

---
## 1) Components

### `components/quotes/QuoteInvoicePage.jsx`
```jsx
import React, { useMemo, useState } from 'react';
import { LineItemsTable } from './parts/LineItemsTable.jsx';
import { TotalsCard } from './parts/TotalsCard.jsx';

// Props expected from Taska (wire these to your stores/services):
// mode: 'quote' | 'invoice'
// initial: { customer, issueDate, dueDate, number, reference, taxMode, items }
// customers: [{ id, name, email, ... }]
// presets: [{ id, name, description, unitPrice, taxType }]
// onSave(payload): Promise<void>
// onSend(payload): Promise<void>
// onPreview?(payload): void

export function QuoteInvoicePage({
  mode = 'invoice',
  initial,
  customers = [],
  presets = [],
  onSave,
  onSend,
  onPreview,
}) {
  const [customerId, setCustomerId] = useState(initial?.customer?.id || '');
  const [issueDate, setIssueDate] = useState(initial?.issueDate || new Date().toISOString().slice(0, 10));
  const [dueDate, setDueDate] = useState(initial?.dueDate || '');
  const [docNo, setDocNo] = useState(initial?.number || '');
  const [reference, setReference] = useState(initial?.reference || '');
  const [taxMode, setTaxMode] = useState(initial?.taxMode || 'exclusive'); // 'exclusive' | 'inclusive'
  const [items, setItems] = useState(
    initial?.items?.length ? initial.items : [
      { id: crypto.randomUUID(), itemName: '', description: '', qty: 1, price: 0, discount: 0, tax: 'GST' },
    ]
  );

  const customer = useMemo(() => customers.find(c => c.id === customerId) || null, [customerId, customers]);

  function setItem(id, key, value) {
    setItems(prev => prev.map(it => (it.id === id ? { ...it, [key]: value } : it)));
  }

  function addRow() {
    setItems(prev => [...prev, { id: crypto.randomUUID(), itemName: '', description: '', qty: 1, price: 0, discount: 0, tax: 'GST' }]);
  }

  function removeRow(id) {
    setItems(prev => (prev.length > 1 ? prev.filter(it => it.id !== id) : prev));
  }

  function applyPreset(id, presetId) {
    const p = presets.find(p => p.id === presetId);
    if (!p) return;
    // ✅ Ensure preset fills name + description + price immediately
    setItems(prev => prev.map(it => (it.id === id ? {
      ...it,
      itemName: p.name,
      description: p.description || p.name,
      price: Number(p.unitPrice || 0),
      tax: p.taxType === 'GST' ? 'GST' : 'None',
    } : it)));
  }

  const totals = useMemo(() => calcTotals(items, taxMode), [items, taxMode]);

  const payload = useMemo(() => ({
    mode,
    customerId,
    header: { issueDate, dueDate, number: docNo, reference, taxMode },
    items,
    totals,
  }), [mode, customerId, issueDate, dueDate, docNo, reference, taxMode, items, totals]);

  async function handleSave() { await onSave?.(payload); }
  async function handleSend() { await onSend?.(payload); }

  return (
    <div className="min-h-screen bg-neutral-50">
      {/* Top bar */}
      <div className="sticky top-0 z-20 bg-white border-b">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-xl bg-yellow-400 grid place-items-center font-black text-neutral-900">T</div>
            <div className="leading-tight">
              <div className="font-semibold text-neutral-800">Taska</div>
              <div className="text-xs text-neutral-500">{mode === 'quote' ? 'Quote' : 'Invoice'} composer</div>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button className="px-3 py-2 rounded-xl border text-sm" onClick={() => onPreview?.(payload)}>Preview</button>
            <button className="px-3 py-2 rounded-xl border text-sm" onClick={handleSave}>Save</button>
            <button className="px-3 py-2 rounded-xl bg-neutral-900 text-white text-sm disabled:opacity-50" disabled={!customerId} onClick={handleSend}>
              {mode === 'quote' ? 'Send quote' : 'Send invoice'}
            </button>
          </div>
        </div>
      </div>

      {/* Header form */}
      <div className="max-w-6xl mx-auto px-4 py-6">
        <div className="grid grid-cols-12 gap-4 bg-white p-4 rounded-2xl shadow-sm border">
          <div className="col-span-12 sm:col-span-4">
            <label className="text-xs font-medium text-neutral-600">Customer</label>
            <select className="mt-1 w-full border rounded-lg px-3 py-2" value={customerId} onChange={e => setCustomerId(e.target.value)}>
              <option value="">Select…</option>
              {customers.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
            </select>
          </div>
          <div className="col-span-6 sm:col-span-2">
            <label className="text-xs font-medium text-neutral-600">Issue date</label>
            <input type="date" value={issueDate} onChange={e => setIssueDate(e.target.value)} className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>
          <div className="col-span-6 sm:col-span-2">
            <label className="text-xs font-medium text-neutral-600">Due date</label>
            <input type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>
          <div className="col-span-6 sm:col-span-2">
            <label className="text-xs font-medium text-neutral-600">{mode === 'quote' ? 'Quote' : 'Invoice'} #</label>
            <input value={docNo} onChange={e => setDocNo(e.target.value)} className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>
          <div className="col-span-6 sm:col-span-2">
            <label className="text-xs font-medium text-neutral-600">Reference</label>
            <input value={reference} onChange={e => setReference(e.target.value)} className="mt-1 w-full border rounded-lg px-3 py-2" />
          </div>
          <div className="col-span-12 sm:col-span-3">
            <label className="text-xs font-medium text-neutral-600">Amounts are</label>
            <select className="mt-1 w-full border rounded-lg px-3 py-2" value={taxMode} onChange={e => setTaxMode(e.target.value)}>
              <option value="exclusive">Tax exclusive</option>
              <option value="inclusive">Tax inclusive</option>
            </select>
          </div>
        </div>

        {/* Items + Totals */}
        <div className="mt-6 grid grid-cols-12 gap-6">
          <div className="col-span-12 lg:col-span-7">
            <LineItemsTable
              items={items}
              onChange={setItems}
              onSetItem={setItem}
              onAddRow={addRow}
              onRemoveRow={removeRow}
              onApplyPreset={applyPreset}
              presets={presets}
              taxMode={taxMode}
            />
            <div className="bg-white rounded-2xl border shadow-sm p-4 mt-4">
              <div className="text-sm font-medium text-neutral-700">Notes / Terms</div>
              <textarea className="mt-2 w-full border rounded-xl px-3 py-2 min-h-[96px]" placeholder="e.g. Payment due within 7 days. Parts remain property of FMF until paid in full."></textarea>
            </div>
          </div>

          <div className="col-span-12 lg:col-span-5">
            <TotalsCard totals={totals} onSend={handleSend} canSend={!!customerId} mode={mode} />
          </div>
        </div>
      </div>
    </div>
  );
}

function calcTotals(items, taxMode) {
  const GST = 0.10;
  const rows = items.map(it => {
    const base = Number(it.qty || 0) * Number(it.price || 0) * (1 - Number(it.discount || 0) / 100);
    if (it.tax === 'GST') {
      if (taxMode === 'inclusive') {
        const ex = base / (1 + GST);
        return { base: ex, gst: ex * GST, total: base };
      }
      return { base, gst: base * GST, total: base * (1 + GST) };
    }
    return { base, gst: 0, total: base };
  });
  const subtotal = rows.reduce((a, r) => a + r.base, 0);
  const gst = rows.reduce((a, r) => a + r.gst, 0);
  const total = rows.reduce((a, r) => a + r.total, 0);
  return { subtotal, gst, total };
}
```

### `components/quotes/parts/LineItemsTable.jsx`
```jsx
import React from 'react';
import { PresetSelect } from './PresetSelect.jsx';

export function LineItemsTable({ items, onChange, onSetItem, onAddRow, onRemoveRow, onApplyPreset, presets, taxMode }) {
  return (
    <div className="bg-white rounded-2xl border shadow-sm overflow-hidden">
      <div className="px-4 py-3 border-b text-sm font-medium text-neutral-600 grid grid-cols-12 gap-2">
        <div className="col-span-2">Item</div>
        <div className="col-span-4">Description</div>
        <div className="col-span-1 text-right">Qty.</div>
        <div className="col-span-2 text-right">Price</div>
        <div className="col-span-1 text-right">Disc. %</div>
        <div className="col-span-1">Tax</div>
        <div className="col-span-1 text-right">Amount</div>
      </div>

      {items.map((it) => {
        const GST = 0.10;
        const base = Number(it.qty || 0) * Number(it.price || 0) * (1 - Number(it.discount || 0) / 100);
        const gst = it.tax === 'GST' ? (taxMode === 'inclusive' ? (base / (1 + GST)) * GST : base * GST) : 0;
        const total = taxMode === 'inclusive' ? base : base + gst;
        return (
          <div key={it.id} className="px-4 py-3 grid grid-cols-12 gap-2 items-start border-b last:border-b-0">
            <div className="col-span-2 flex gap-2">
              <input value={it.itemName} onChange={(e) => onSetItem(it.id, 'itemName', e.target.value)} placeholder="Item name" className="w-full border rounded-lg px-3 py-2" />
              <PresetSelect presets={presets} onSelect={(pid) => onApplyPreset(it.id, pid)} />
            </div>
            <div className="col-span-4">
              <input value={it.description} onChange={(e) => onSetItem(it.id, 'description', e.target.value)} placeholder="Description" className="w-full border rounded-lg px-3 py-2" />
            </div>
            <div className="col-span-1 text-right">
              <input type="number" step="0.01" value={it.qty} onChange={(e) => onSetItem(it.id, 'qty', Number(e.target.value))} className="w-full border rounded-lg px-3 py-2 text-right" />
            </div>
            <div className="col-span-2 text-right">
              <input type="number" step="0.01" value={it.price} onChange={(e) => onSetItem(it.id, 'price', Number(e.target.value))} className="w-full border rounded-lg px-3 py-2 text-right" />
            </div>
            <div className="col-span-1 text-right">
              <input type="number" step="0.01" value={it.discount} onChange={(e) => onSetItem(it.id, 'discount', Number(e.target.value))} className="w-full border rounded-lg px-3 py-2 text-right" />
            </div>
            <div className="col-span-1">
              <select value={it.tax} onChange={(e) => onSetItem(it.id, 'tax', e.target.value)} className="w-full border rounded-lg px-3 py-2">
                <option>GST</option>
                <option>None</option>
              </select>
            </div>
            <div className="col-span-1 text-right font-medium pt-2">{currency(total)}</div>
            <div className="col-span-12 flex items-center justify-between pt-2">
              <button className="text-sm text-neutral-600 hover:text-neutral-900" onClick={onAddRow}>+ Add row</button>
              {items.length > 1 && (
                <button className="text-sm text-red-600" onClick={() => onRemoveRow(it.id)}>Remove</button>
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}

function currency(n) {
  const v = isFinite(n) ? n : 0;
  return v.toLocaleString(undefined, { style: 'currency', currency: 'AUD' });
}
```

### `components/quotes/parts/PresetSelect.jsx`
```jsx
import React from 'react';
export function PresetSelect({ presets, onSelect }) {
  return (
    <select className="border rounded-lg px-2" onChange={(e) => onSelect(e.target.value)} defaultValue="">
      <option value="" disabled>+ Preset</option>
      {presets.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
    </select>
  );
}
```

### `components/quotes/parts/TotalsCard.jsx`
```jsx
import React from 'react';
export function TotalsCard({ totals, onSend, canSend, mode }) {
  return (
    <div className="bg-white rounded-2xl border shadow-sm p-4">
      <Row label="Subtotal" value={totals.subtotal} />
      <Row label="Total GST" value={totals.gst} />
      <div className="h-px bg-neutral-200 my-3" />
      <div className="flex items-center justify-between text-lg font-semibold">
        <span>Total</span>
        <span>{currency(totals.total)}</span>
      </div>
      <div className="mt-4 flex gap-2">
        <button className="flex-1 px-3 py-2 rounded-xl bg-neutral-900 text-white text-sm disabled:opacity-50" disabled={!canSend} onClick={onSend}>
          {mode === 'quote' ? 'Send quote' : 'Send invoice'}
        </button>
        <button className="px-3 py-2 rounded-xl border text-sm" onClick={() => window.print()}>Print</button>
      </div>
    </div>
  );
}

function Row({ label, value }) {
  return (
    <div className="flex items-center justify-between text-sm">
      <span className="text-neutral-600">{label}</span>
      <span className="font-medium">{currency(value)}</span>
    </div>
  );
}

function currency(n) {
  const v = isFinite(n) ? n : 0;
  return v.toLocaleString(undefined, { style: 'currency', currency: 'AUD' });
}
```

---
## 2) How to Wire Into Taska (no backend changes)

1. **Import the page** where you currently render quotes/invoices (e.g. `routes/quotes/[id].jsx` or similar):
```jsx
import { QuoteInvoicePage } from '@/components/quotes/QuoteInvoicePage.jsx';
```
2. **Feed it your existing data** (from your stores/services):
```jsx
<QuoteInvoicePage
  mode={isQuote ? 'quote' : 'invoice'}
  initial={existingDoc}
  customers={customers}
  presets={itemPresets}
  onSave={(payload) => saveQuoteOrInvoice(payload)}
  onSend={(payload) => sendQuoteOrInvoice(payload)}
  onPreview={(payload) => openPreview(payload)}
/>
```
3. **Ensure preset objects** include: `{ id, name, description, unitPrice, taxType }` so preset apply fills **name + description + price** immediately.

> If your preset model uses different keys, map it before passing to the component (e.g. `{ unitPrice: p.price }`).

---
## 3) Visual Tweaks You Can Flip On/Off
- Move totals card to **right** (already default). Change to bottom on mobile via grid order if desired.
- Show/Hide **discount** column: set a prop `showDiscount={false}` and conditionally render columns.
- Larger fonts: add `text-[15px]` on table inputs.
- Tighten spacing: change paddings `px-3 py-2` → `px-2 py-1.5`.

---
## 4) Preset “Price not filling” — Hard Fix
If your current handler only sets description, replace with this logic wherever presets are applied:
```js
function applyPresetToRow(row, preset) {
  return {
    ...row,
    itemName: preset.name,
    description: preset.description || preset.name,
    price: Number(preset.unitPrice || preset.price || 0),
    tax: preset.taxType === 'GST' ? 'GST' : 'None',
  };
}
```
Then commit to state with an immutable update (as shown above).

---
## 5) Accessibility & Keyboard Speed
- `Tab` moves across cells left→right, row→row for fast entry.
- Press `Enter` on Price to **add row** (optional small enhancement).
- Add `aria-label`s if needed for screen readers.

---
## 6) QA Checklist (copy/paste to PR)
- [ ] Preset sets **name + description + price + tax** in one click
- [ ] Tax inclusive/exclusive math matches Xero on 4 test cases
- [ ] Discount % applies per line and updates totals
- [ ] Totals block shows Subtotal / GST / Total accurately
- [ ] Save/Send triggers your existing actions unchanged
- [ ] Mobile view readable (12‑14px min, inputs full width)
- [ ] Print view clean (hide buttons/top bar with `@media print`)

---
## 7) Optional: Tiny Style Sheet Additions
If you want Xero‑like compact density, add:
```css
/* app.css */
.table-input { @apply w-full border rounded-lg px-2 py-1.5 text-[14px]; }
```
And swap `className="w-full border rounded-lg px-3 py-2"` → `className="table-input"` in inputs.

---
## 8) That’s it
No backend migrations, no new endpoints. This is a **pure reskin** with a proper preset fix. Drop it in, wire your existing data/actions, and enjoy the smooth Xero vibe without losing any Taska brains.
